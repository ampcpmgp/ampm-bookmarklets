name: PR Build and Artifact

on:
  pull_request:
    branches:
      - main
    types: [opened, synchronize, reopened]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm install

      - name: Build bookmarklets
        run: node build.js

      - name: Upload built HTML artifact
        uses: actions/upload-artifact@v4
        with:
          name: built-html
          path: index.html
          retention-days: 30

      - name: Upload full build output
        uses: actions/upload-artifact@v4
        with:
          name: build-output
          path: |
            index.html
            bookmarklets/
          retention-days: 30

      - name: Comment PR with artifact info
        uses: actions/github-script@v7
        with:
          script: |
            const message = `## ğŸ‰ Build Successful!
            
            ãƒ“ãƒ«ãƒ‰ã•ã‚ŒãŸHTMLãƒ•ã‚¡ã‚¤ãƒ«ãŒåˆ©ç”¨å¯èƒ½ã§ã™ï¼š
            
            ### ğŸ“¦ Artifacts
            - **built-html**: ãƒ“ãƒ«ãƒ‰ã•ã‚ŒãŸ \`index.html\` ãƒ•ã‚¡ã‚¤ãƒ«
            - **build-output**: å®Œå…¨ãªãƒ“ãƒ«ãƒ‰å‡ºåŠ›ï¼ˆindex.html + bookmarklets/ï¼‰
            
            ### ğŸ“¥ ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰æ–¹æ³•
            1. ã“ã®PRã®ã€ŒChecksã€ã‚¿ãƒ–ã‚’ã‚¯ãƒªãƒƒã‚¯
            2. å·¦å´ã®ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‹ã‚‰ã€ŒPR Build and Artifactã€ã‚’é¸æŠ
            3. ã€ŒSummaryã€ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã«ã‚ã‚‹ã€ŒArtifactsã€ã‹ã‚‰ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
            
            ã¾ãŸã¯ã€[ã“ã¡ã‚‰ã®ãƒªãƒ³ã‚¯](${context.payload.repository.html_url}/actions/runs/${context.runId}) ã‹ã‚‰ç›´æ¥ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã™ã€‚
            
            ### ğŸ” æˆæœç‰©ã®ç¢ºèª
            ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ãŸHTMLãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ–ãƒ©ã‚¦ã‚¶ã§é–‹ã„ã¦ã€ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã®å‹•ä½œã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚`;
            
            const identifier = '<!-- pr-build-artifact-comment -->';
            const messageWithIdentifier = identifier + '\n' + message;
            
            // Check if a comment already exists
            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            
            const existingComment = comments.data.find(comment => 
              comment.body.includes(identifier)
            );
            
            if (existingComment) {
              // Update existing comment
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existingComment.id,
                body: messageWithIdentifier
              });
            } else {
              // Create new comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: messageWithIdentifier
              });
            }
